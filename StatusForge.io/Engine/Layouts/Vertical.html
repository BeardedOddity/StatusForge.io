<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BearddOddity Vertical Widget</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800;900&display=swap');
  body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: transparent; display: flex; justify-content: center; align-items: start; -webkit-font-smoothing: antialiased; }
  
  /* Container and Game Art standardized to 360px */
  .widget-container { width: 360px; display: flex; flex-direction: column; align-items: center; font-family: 'Montserrat', sans-serif; margin-top: 25px; opacity: 0; transition: opacity 1s ease-in-out; }
  .game-art { width: 360px; height: 450px; background-size: cover; background-position: center; border-radius: 60px; z-index: 2; position: relative; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0px 20px 40px rgba(0,0,0,0.8); background-color: #111; }
  
  .game-art::after { content: ""; position: absolute; top: -50%; left: -60%; width: 30%; height: 200%; background: rgba(255, 255, 255, 0.15); transform: rotate(35deg); animation: glossShine 7s infinite ease-in-out; }
  @keyframes glossShine { 0% { left: -100%; } 15% { left: 150%; } 100% { left: 150%; } }
  
  /* Info box remains 360px to match */
  .info-box { width: 360px; min-height: 180px; margin-top: -60px; border-radius: 40px; z-index: 1; background: rgba(0, 0, 0, 0.65); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0px 10px 30px rgba(0,0,0,0.6); overflow: hidden; padding-top: 60px; }
  .info-content { padding: 30px 20px 40px 20px; text-align: center; }
  .metallic-text { background: linear-gradient(to bottom, #ffffff 0%, #dcdcdc 50%, #ffffff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.8)); display: inline-block; }
  .game-title { font-weight: 900; margin-bottom: 12px; line-height: 1.1; font-size: 24px; width: 100%; word-wrap: break-word; }
  .slider-stage { position: relative; height: 60px; overflow: hidden; width: 100%; }
  
  /* Upgraded animation for 4 data points */
  .slider-track { position: absolute; width: 100%; animation: slideData 16s infinite ease-in-out; }
  @keyframes slideData { 
      0%, 20% { transform: translateY(0); } 
      25%, 45% { transform: translateY(-60px); } 
      50%, 70% { transform: translateY(-120px); } 
      75%, 95% { transform: translateY(-180px); } 
      100% { transform: translateY(0); } 
  }
  
  .slide-item { height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  .label-text { font-weight: 800; text-transform: uppercase; letter-spacing: 2px; font-size: 13px; margin-bottom: 2px; color: rgba(255, 255, 255, 0.4); }
  .data-text { font-weight: 800; font-size: 18px; line-height: 1.1; }
</style>
</head>
<body>
<div class="widget-container" id="w">
  <div class="game-art" id="a"></div>
  <div class="info-box">
    <div class="info-content">
      <div id="t" class="metallic-text game-title">...</div>
      <div class="slider-stage">
        <div class="slider-track">
          <div class="slide-item"><span class="label-text">Released</span><span id="r" class="metallic-text data-text">...</span></div>
          <div class="slide-item"><span class="label-text">Genre</span><span id="g" class="metallic-text data-text">...</span></div>
          <div class="slide-item"><span class="label-text">Publisher</span><span id="p" class="metallic-text data-text">...</span></div>
          <div class="slide-item"><span class="label-text">Session</span><span id="s" class="metallic-text data-text">00:00:00</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    let lastGame = "";
    let sessionInterval;
    let widgetFadeTimer = null; // Memory for the custom fade countdown
    let startTime = 0;
    let pollRate = 3000;

    async function initializeWidget() {
        try {
            const url = 'http://127.0.0.1:5050/settings?nocache=' + new Date().getTime();
            const setRes = await fetch(url);
            const setJson = await setRes.json();
            pollRate = (setJson.widget_poll_rate || 3) * 1000;
        } catch(e) {}
        setInterval(pollEngine, pollRate);
        pollEngine();
    }

    async function pollEngine() {
        try {
            const url = 'http://127.0.0.1:5050/status?nocache=' + new Date().getTime();
            const res = await fetch(url);
            const data = await res.json();
            const w = document.getElementById("w"); 

            if (data.is_playing) {
                startTime = data.start_time;
                if (!sessionInterval) sessionInterval = setInterval(updateTimer, 1000);
                
                // Only trigger visual updates and timers if the game actually changes!
                if (data.game_title !== lastGame) {
                    lastGame = data.game_title;
                    
                    // 1. Clear any active fade out timers
                    if (widgetFadeTimer) clearTimeout(widgetFadeTimer);
                    
                    // 2. Bring the widget on screen
                    w.style.opacity = "1";
                    
                    // 3. Update all metadata
                    smoothTextUpdate("t", data.game_title); 
                    smoothTextUpdate("r", data.release_date || "UNKNOWN");
                    smoothTextUpdate("g", data.genre || "GAMING");
                    smoothTextUpdate("p", data.publisher || "INDIE / UNKNOWN");
                    
                    if (data.cover_url) {
                        applyCoverArt(data.cover_url);
                    } else {
                        applyCoverArt(''); // Blank if none found
                    }
                    
                    // 4. Start the custom fade out countdown (if enabled in Dashboard)
                    if (data.fade_timer > 0) {
                        widgetFadeTimer = setTimeout(() => {
                            w.style.opacity = "0";
                        }, data.fade_timer * 1000);
                    }
                }
            } else {
                w.style.opacity = "0"; 
                lastGame = "";
                clearInterval(sessionInterval);
                sessionInterval = null;
                if (widgetFadeTimer) clearTimeout(widgetFadeTimer);
            }
        } catch(e) {}
    }

    function smoothTextUpdate(id, text) {
        const el = document.getElementById(id);
        if(!el) return;
        el.style.opacity = 0;
        setTimeout(() => { el.innerText = text; el.style.opacity = 1; }, 500); 
    }

    function applyCoverArt(url) {
        const cover = document.getElementById('a');
        if(!cover) return;
        cover.style.opacity = 0;
        setTimeout(() => {
            if(url) {
                cover.style.backgroundImage = `url('${url}')`;
                cover.style.backgroundColor = '#111';
            } else {
                cover.style.backgroundImage = 'none';
                cover.style.backgroundColor = '#050505'; // Fallback empty state
            }
            cover.style.opacity = 1;
        }, 500);
    }

    function updateTimer() {
        if (!startTime) return;
        const diff = Math.floor(Date.now() / 1000) - Math.floor(startTime);
        if (diff < 0) return;
        const h = String(Math.floor(diff / 3600)).padStart(2, '0');
        const m = String(Math.floor((diff % 3600) / 60)).padStart(2, '0');
        const s = String(diff % 60).padStart(2, '0');
        const el = document.getElementById("s"); 
        if (el) el.innerText = `${h}:${m}:${s}`;
    }

    initializeWidget();
</script>
</body>
</html>
